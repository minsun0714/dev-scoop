name: "CI/CD: Build and Deploy with Docker Compose"

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE_NAME: devscoop-api
  DOCKER_TAG: latest
  CONTAINER_NAME: devscoop-api

jobs:
  build-and-push:
    name: Docker Build & Push
    runs-on: ubuntu-latest

    steps:
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: JDK ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ ì£¼ì…
        run: |
          echo "REDDIT_CLIENT_ID=dummy" >> $GITHUB_ENV
          echo "REDDIT_SECRET=dummy" >> $GITHUB_ENV
          echo "REDDIT_USERNAME=dummy" >> $GITHUB_ENV
          echo "REDDIT_PASSWORD=dummy" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=dummy" >> $GITHUB_ENV
          echo "MYSQL_URL=jdbc:h2:mem:testdb" >> $GITHUB_ENV
          echo "MYSQL_USERNAME=sa" >> $GITHUB_ENV
          echo "MYSQL_PASSWORD=" >> $GITHUB_ENV
          echo "KAFKA_BOOTSTRAP_SERVERS=localhost:9092" >> $GITHUB_ENV
          echo "ELASTICSEARCH_HOST=localhost" >> $GITHUB_ENV
          echo "ELASTICSEARCH_PORT=9200" >> $GITHUB_ENV

      - name: Gradle ë¹Œë“œ (test profile)
        run: ./gradlew clean build -Dspring.profiles.active=test

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê¹…
        run: |
          REMOTE_IMAGE=${{ secrets.DOCKER_USERNAME }}/$DOCKER_IMAGE_NAME:$DOCKER_TAG
          docker build -t $DOCKER_IMAGE_NAME:$DOCKER_TAG .
          docker tag $DOCKER_IMAGE_NAME:$DOCKER_TAG $REMOTE_IMAGE
          echo "REMOTE_IMAGE=$REMOTE_IMAGE" >> $GITHUB_ENV

      - name: Docker Hubì— ì´ë¯¸ì§€ Push
        run: docker push $REMOTE_IMAGE

  deploy:
    name: Deploy on EC2 (docker compose)
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: EC2 ì ‘ì† ë° ë°°í¬
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ec2-user/devscoop  # docker-compose.yml ìœ„ì¹˜

            echo "ğŸ³ Docker & Compose ë²„ì „ í™•ì¸"
            docker --version
            docker compose version || true

            echo "ğŸ§¹ ì˜¤ë˜ëœ ì»¨í…Œì´ë„ˆ/ì´ë¯¸ì§€ ì •ë¦¬"
            sudo docker container prune -f
            sudo docker image prune -f

            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ Pull"
            sudo docker compose pull devscoop-api

            echo "ğŸš€ ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
            sudo docker compose up -d devscoop-api

            echo "ğŸ” ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
            sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}" | grep devscoop-api

            echo "â³ ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°"
            sleep 10

            echo "âœ… Health check passed!"
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ"
